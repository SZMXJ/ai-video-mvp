generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  // Prisma 7 + prisma.config.ts: 这里不写 url
}

model User {
  id      String  @id @default(cuid())
  email   String? @unique
  credits Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  jobs      Job[]
  ledger    CreditLedger[]
  videoJobs VideoJob[]
}

model Job {
  id String @id @default(cuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  mode      String
  modelId   String
  requestId String @unique

  status String @default("QUEUED") // QUEUED/IN_PROGRESS/COMPLETED/FAILED

  prompt     String?
  inputJson  Json
  outputJson Json?
  result     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model CreditLedger {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  delta  Int // -扣费，+充值/返还
  reason String // e.g. "JOB_CHARGE", "STRIPE_TOPUP"
  meta   Json?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model VideoJob {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status   String // "generating" | "done" | "failed"
  prompt   String
  modelKey String

  durationSec Int
  aspectRatio String
  resolution  String?

  creditsCost Int

  remoteUrl String?
  videoUrl  String?
  error     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}
