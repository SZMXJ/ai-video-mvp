generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
  // Prisma 7 + prisma.config.ts: 这里不写 url
}

model User {
  id      String  @id @default(cuid())
  email   String? @unique

  credits Int     @default(0)

  // ✅ 必填且唯一：你所有逻辑用它定位用户
  betaKey String  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs          Job[]
  ledger        CreditLedger[]
  videoJobs     VideoJob[]
  stripeSessions StripeCheckoutSession[] // ✅ 补上反向关系，避免你之前 P1012
}

model StripeCheckoutSession {
  id        String   @id // 直接用 Stripe session.id
  userId    String
  credits   Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model CreditLedger {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  delta  Int
  reason String
  meta   Json?

  // ✅ 幂等 key：必须唯一
  idempotencyKey String @unique

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Job {
  id String @id @default(cuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  mode      String
  modelId   String
  requestId String @unique

  status String @default("QUEUED")

  prompt     String?
  inputJson  Json
  outputJson Json?
  result     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model VideoJob {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status   String
  prompt   String
  modelKey String

  durationSec Int
  aspectRatio String
  resolution  String?

  creditsCost Int

  remoteUrl String?
  videoUrl  String?
  error     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}
